{"ast":null,"code":"import { isURL, IS_FIREFOX, MAX_STR_LEN, createMutationObserver } from '../utils.js';\nimport { ResourceTiming, SetNodeAttributeURLBased } from '../app/messages.gen.js';\nimport { hasTag } from '../app/guards.js';\nfunction resolveURL(url, location = document.location) {\n  url = url.trim();\n  if (url.startsWith('//') || url.startsWith('http://') || url.startsWith('https://') || url.startsWith('data:') // any other possible value here? https://bugzilla.mozilla.org/show_bug.cgi?id=1758035\n  ) {\n    return url;\n  } else if (url.startsWith('/')) {\n    return location.origin + url;\n  } else {\n    return location.origin + location.pathname + url;\n  }\n}\n// https://bugzilla.mozilla.org/show_bug.cgi?id=1607081\nfunction isSVGInFireFox(url) {\n  return IS_FIREFOX && (url.startsWith('data:image/svg+xml') || url.match(/.svg$|/i));\n}\nconst PLACEHOLDER_SRC = 'https://static.openreplay.com/tracker/placeholder.jpeg';\nexport default function (app) {\n  function sendPlaceholder(id, node) {\n    app.attributeSender.sendSetAttribute(id, 'src', PLACEHOLDER_SRC);\n    const {\n      width,\n      height\n    } = node.getBoundingClientRect();\n    if (!node.hasAttribute('width')) {\n      app.attributeSender.sendSetAttribute(id, 'width', String(width));\n    }\n    if (!node.hasAttribute('height')) {\n      app.attributeSender.sendSetAttribute(id, 'height', String(height));\n    }\n  }\n  const sendSrcset = function (id, img) {\n    const {\n      srcset\n    } = img;\n    if (!srcset) {\n      return;\n    }\n    const resolvedSrcset = srcset.split(',').map(str => resolveURL(str)).join(',');\n    app.attributeSender.sendSetAttribute(id, 'srcset', resolvedSrcset);\n  };\n  const sendSrc = function (id, img) {\n    if (img.src.length > MAX_STR_LEN) {\n      sendPlaceholder(id, img);\n    }\n    app.send(SetNodeAttributeURLBased(id, 'src', img.src, app.getBaseHref()));\n  };\n  const sendImgError = app.safe(function (img) {\n    const resolvedSrc = resolveURL(img.src || ''); // Src type is null sometimes. - is it true?\n    if (isURL(resolvedSrc)) {\n      app.send(ResourceTiming(app.timestamp(), 0, 0, 0, 0, 0, resolvedSrc, 'img', 0, false));\n    }\n  });\n  const sendImgAttrs = app.safe(function (img) {\n    const id = app.nodes.getID(img);\n    if (id === undefined) {\n      return;\n    }\n    if (!img.complete) {\n      return;\n    }\n    if (img.naturalHeight === 0 && img.naturalWidth === 0 && !isSVGInFireFox(img.src)) {\n      sendImgError(img);\n    } else if (app.sanitizer.isHidden(id) || app.sanitizer.isObscured(id)) {\n      sendPlaceholder(id, img);\n    } else {\n      sendSrc(id, img);\n      sendSrcset(id, img);\n    }\n  });\n  const observer = createMutationObserver(app.safe(mutations => {\n    for (const mutation of mutations) {\n      if (mutation.type === 'attributes') {\n        const target = mutation.target;\n        const id = app.nodes.getID(target);\n        if (id === undefined) {\n          return;\n        }\n        if (mutation.attributeName === 'src') {\n          sendSrc(id, target);\n        }\n        if (mutation.attributeName === 'srcset') {\n          sendSrcset(id, target);\n        }\n      }\n    }\n  }));\n  app.attachStopCallback(() => {\n    observer.disconnect();\n  });\n  app.nodes.attachNodeCallback(node => {\n    if (!hasTag(node, 'img')) {\n      return;\n    }\n    app.nodes.attachNodeListener(node, 'error', () => sendImgError(node));\n    app.nodes.attachNodeListener(node, 'load', () => sendImgAttrs(node));\n    sendImgAttrs(node);\n    observer.observe(node, {\n      attributes: true,\n      attributeFilter: ['src', 'srcset']\n    });\n  });\n}","map":{"version":3,"names":["isURL","IS_FIREFOX","MAX_STR_LEN","createMutationObserver","ResourceTiming","SetNodeAttributeURLBased","hasTag","resolveURL","url","location","document","trim","startsWith","origin","pathname","isSVGInFireFox","match","PLACEHOLDER_SRC","app","sendPlaceholder","id","node","attributeSender","sendSetAttribute","width","height","getBoundingClientRect","hasAttribute","String","sendSrcset","img","srcset","resolvedSrcset","split","map","str","join","sendSrc","src","length","send","getBaseHref","sendImgError","safe","resolvedSrc","timestamp","sendImgAttrs","nodes","getID","undefined","complete","naturalHeight","naturalWidth","sanitizer","isHidden","isObscured","observer","mutations","mutation","type","target","attributeName","attachStopCallback","disconnect","attachNodeCallback","attachNodeListener","observe","attributes","attributeFilter"],"sources":["/Users/paramvirrotwal/Observability/website-admin-react-web-app-project/node_modules/@openreplay/tracker/lib/modules/img.js"],"sourcesContent":["import { isURL, IS_FIREFOX, MAX_STR_LEN, createMutationObserver } from '../utils.js';\nimport { ResourceTiming, SetNodeAttributeURLBased } from '../app/messages.gen.js';\nimport { hasTag } from '../app/guards.js';\nfunction resolveURL(url, location = document.location) {\n    url = url.trim();\n    if (url.startsWith('//') ||\n        url.startsWith('http://') ||\n        url.startsWith('https://') ||\n        url.startsWith('data:') // any other possible value here? https://bugzilla.mozilla.org/show_bug.cgi?id=1758035\n    ) {\n        return url;\n    }\n    else if (url.startsWith('/')) {\n        return location.origin + url;\n    }\n    else {\n        return location.origin + location.pathname + url;\n    }\n}\n// https://bugzilla.mozilla.org/show_bug.cgi?id=1607081\nfunction isSVGInFireFox(url) {\n    return IS_FIREFOX && (url.startsWith('data:image/svg+xml') || url.match(/.svg$|/i));\n}\nconst PLACEHOLDER_SRC = 'https://static.openreplay.com/tracker/placeholder.jpeg';\nexport default function (app) {\n    function sendPlaceholder(id, node) {\n        app.attributeSender.sendSetAttribute(id, 'src', PLACEHOLDER_SRC);\n        const { width, height } = node.getBoundingClientRect();\n        if (!node.hasAttribute('width')) {\n            app.attributeSender.sendSetAttribute(id, 'width', String(width));\n        }\n        if (!node.hasAttribute('height')) {\n            app.attributeSender.sendSetAttribute(id, 'height', String(height));\n        }\n    }\n    const sendSrcset = function (id, img) {\n        const { srcset } = img;\n        if (!srcset) {\n            return;\n        }\n        const resolvedSrcset = srcset\n            .split(',')\n            .map((str) => resolveURL(str))\n            .join(',');\n        app.attributeSender.sendSetAttribute(id, 'srcset', resolvedSrcset);\n    };\n    const sendSrc = function (id, img) {\n        if (img.src.length > MAX_STR_LEN) {\n            sendPlaceholder(id, img);\n        }\n        app.send(SetNodeAttributeURLBased(id, 'src', img.src, app.getBaseHref()));\n    };\n    const sendImgError = app.safe(function (img) {\n        const resolvedSrc = resolveURL(img.src || ''); // Src type is null sometimes. - is it true?\n        if (isURL(resolvedSrc)) {\n            app.send(ResourceTiming(app.timestamp(), 0, 0, 0, 0, 0, resolvedSrc, 'img', 0, false));\n        }\n    });\n    const sendImgAttrs = app.safe(function (img) {\n        const id = app.nodes.getID(img);\n        if (id === undefined) {\n            return;\n        }\n        if (!img.complete) {\n            return;\n        }\n        if (img.naturalHeight === 0 && img.naturalWidth === 0 && !isSVGInFireFox(img.src)) {\n            sendImgError(img);\n        }\n        else if (app.sanitizer.isHidden(id) || app.sanitizer.isObscured(id)) {\n            sendPlaceholder(id, img);\n        }\n        else {\n            sendSrc(id, img);\n            sendSrcset(id, img);\n        }\n    });\n    const observer = createMutationObserver(app.safe((mutations) => {\n        for (const mutation of mutations) {\n            if (mutation.type === 'attributes') {\n                const target = mutation.target;\n                const id = app.nodes.getID(target);\n                if (id === undefined) {\n                    return;\n                }\n                if (mutation.attributeName === 'src') {\n                    sendSrc(id, target);\n                }\n                if (mutation.attributeName === 'srcset') {\n                    sendSrcset(id, target);\n                }\n            }\n        }\n    }));\n    app.attachStopCallback(() => {\n        observer.disconnect();\n    });\n    app.nodes.attachNodeCallback((node) => {\n        if (!hasTag(node, 'img')) {\n            return;\n        }\n        app.nodes.attachNodeListener(node, 'error', () => sendImgError(node));\n        app.nodes.attachNodeListener(node, 'load', () => sendImgAttrs(node));\n        sendImgAttrs(node);\n        observer.observe(node, { attributes: true, attributeFilter: ['src', 'srcset'] });\n    });\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}